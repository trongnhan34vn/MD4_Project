<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Giỏ hàng</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link
            href="https://fonts.googleapis.com/css2?family=Oswald:wght@300&family=Roboto:ital,wght@0,500;0,700;1,300&display=swap"
            rel="stylesheet"/>
    <link rel="shortcut icon" type="image/x-icon"
          href="https://theme.hstatic.net/200000388065/1000766714/14/logo.png?v=111"/>
    <!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"-->
    <!--          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">-->
    <link rel="stylesheet" th:href="@{/assets/css/base1.css}"/>
    <link rel="stylesheet" th:href="@{/assets/css/main.css}"/>
    <link rel="stylesheet" th:href="@{/assets/fonts/fontawesome-free-6.2.0-web/css/all.css}"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css"/>
</head>

<body>
<div class="app">
    <!-- Header -->
    <div class="header">
        <div class="header-navbar__contact">
            <div class="header-navbar__contact-item">
                <i class="fa-sharp fa-solid fa-house-chimney"></i>
                <a href="">Hệ thống cửa hàng</a>
            </div>
            <div class="header-navbar__contact-item">
                <i class="fa-solid fa-phone"></i>
                <a href="">Mua hàng online: 0969436769</a>
            </div>
        </div>
        <div class="header-navbar-feat">
            <div class="grid">
                <div class="header-navbar-container header-navbar-container--cart">
                    <div class="header-navbar-cart-item">
                        <div class="header-navbar-item">
                            <div class="header-navbar__logo">
                                <a href="/">
                                    <img src="https://theme.hstatic.net/200000388065/1000766714/14/logo.png?v=111"
                                         alt=""/>
                                </a>
                            </div>
                        </div>
                        <div class="header-navbar-item">
                            <h1 class="header-navbar-cart-item">
                                Shopping Cart
                            </h1>
                        </div>
                    </div>
                    <div class="header-navbar-item header-navbar-cart__user">
                        <ul class="header-navbar__features">
                            <li class="nav-account">
                                <span><i class="bi bi-person-circle"></i><span id="account">Tài khoản</span></span>
                                <!-- Regis & Login -->
                                <div class="nav-account-container nav-account-container--cart-products">
                                    <a class="sign-up account-info" href="#">Đăng kí</a>
                                    <a class="sign-in account-cart" href="#">Đăng nhập</a>
                                    <a onclick="logOut()" class="logOut" href="login.html"></a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="path path-">
        <div class="grid">
            <h1>
                <a style="
                                text-decoration: none;
                                color: #000;
                            " href="/">Trang chủ</a>
                / Giỏ hàng
            </h1>
        </div>
    </div>
    <div class="register product-lists">
        <div class="grid">
            <div class="product-list-wrap">
                <table class="products-table" style="width: 100%">
                    <tr style="
                                    height: 50px;
                                    border-bottom: 1px solid #f5f6f9;
                                ">
                        <th width="50%" colspan="3">Products</th>
                        <th>Unit Price</th>
                        <th>Quantity</th>
                        <th>Total Price</th>
                        <th>Actions</th>
                    </tr>
                    <div>
                    </div>
                    <tbody id="draw-table">
                    <!--                    <th:block th:each="cart : ${cartList}">-->
                    <!--                        <tr id="deleteTable">-->
                    <!--                            <td>-->
                    <!--                                <input data-quantity="${cartList[i].quantity}"-->
                    <!--                                       onchange="checkInput()"-->
                    <!--                                       id="${cartList[i].id}"-->
                    <!--                                       name="point"-->
                    <!--                                       type="checkbox" class="check-btn"-->
                    <!--                                       data-price="${cartList[i].price}"/>-->
                    <!--                            </td>-->
                    <!--                            <td>-->
                    <!--                                <img style="width: 80px"-->
                    <!--                                     th:src="@{'/images/' + ${cart.getProduct().getListImgs().get(0).getUrl()}}"-->
                    <!--                                     alt="">-->
                    <!--                            </td>-->
                    <!--                            <td>-->
                    <!--                                <p style="font-weight: bold; text-align: left;"-->
                    <!--                                   th:text="${cart.getProduct().getProductName()}">${cartList[i].name}</p>-->
                    <!--                            </td>-->
                    <!--                            <td style="color: red;" th:text="${config.format(cart.getProduct().getPrice())}">-->
                    <!--                                ${formatNumber(cartList[i].price)}-->
                    <!--                            </td>-->
                    <!--                            <td><input th:value="${cart.getQuantity()}" min="1" style="text-align: center"-->
                    <!--                                       value="${cartList[i].quantity}" type="number"></td>-->
                    <!--                            <td style="color: red;" class="total" id="id + ${cartList[i].id}"-->
                    <!--                                th:text="${config.format(cart.getQuantity()*cart.getProduct().getPrice())}"></td>-->
                    <!--                            <td>-->
                    <!--                                <button>Update</button>-->
                    <!--                                <button>Delete</button>-->
                    <!--                            </td>-->
                    <!--                        </tr>-->
                    <!--                    </th:block>-->

                    </tbody>
                    <tfoot>
                    <tr>
                        <td colspan="6"></td>
                    </tr>
                    </tfoot>
                </table>
            </div>
            <div id="check-cart" class="check-out">
                <div class="check-out-select">
                    <input onchange="checkAllInput()" id="select-all" style="width:20px;" type="checkbox">
                    <h1>Select All</h1>
                </div>
                <div class="check-out-bill">
                    <div class="check-out-total-price">
                        <div style="margin-right: 8px" class="total-price">
                            <h1>
                                Total: <span id="total"></span>
                            </h1>
                        </div>
                        <form action="/order/sendPreOrder" method="get">
                            <button id="checkOutBtn" class="btn">
                                Check Out
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="footer" class="footer">
        <div class="grid">
            <div class="footer-container">
                <div class="footer-logo">
                    <img src="https://theme.hstatic.net/200000388065/1000766714/14/logo.png?v=111" alt=""/>
                </div>
                <ul class="footer-social">
                    <li>
                        <a href=""><i class="bi bi-youtube"></i></a>
                    </li>
                    <li>
                        <a href=""><i class="bi bi-instagram"></i></a>
                    </li>
                    <li>
                        <a href=""><i class="bi bi-facebook"></i></a>
                    </li>
                    <li>
                        <a href=""><i class="bi bi-twitter"></i></a>
                    </li>
                </ul>
                <div class="footer-copyright">
                    <h3>© 2021 GUITARPLUS • ALL RIGHTS RESERVED</h3>
                </div>
                <ul class="footer-link">
                    <li><a href="">Trang chủ</a></li>
                    <li><a href="">Sản phẩm</a></li>
                    <li><a href="">Thương hiệu</a></li>
                    <li><a href="">Blog</a></li>
                    <li><a href="">Giới thiệu</a></li>
                    <li><a href="">Liên hệ</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
</body>
<script th:src="@{/assets/js/fixedBarCart.js}"></script>
<script th:inline="javascript">

    let holdCheckedInput = [];

    function showCart(value) {

        let drawTable = '';
        drawTable = `<tr id="deleteTable">
                        <td>
                            <input data-quantity="${value.quantity}"
                            id="${value.cartId}" name="id"
                            onchange="checkInput(${value.cartId})"
                            type="checkbox" class="check-btn"
                            data-price="${value.product.price * value.quantity}"/>
                        </td>
                        <td>
                            <img style="width: 80px"
                                    src="/images/${value.product.listImgs[0].url}"
                                    alt="">
                        </td>
                        <td>
                            <p style="font-weight: bold; text-align: left;">${value.product.productName
        }</p>
                        </td>
                        <td style="color: red;">${formatNumber(
            value.product.price
        )}</td>
                        <td>
                            <input min="1" style="text-align: center" id="cartId-${value.cartId}" name="quantity" value="${value.quantity}" onchange="updateQuantity(${value.cartId})" type="number">
                        </td>
                        <td style="color: red;" class="total" id="subTotal-${value.cartId}">
                        <input id="checkTotal-${value.cartId}" value="${value.quantity * value.product.price}" hidden="hidden"/>
                        </td>
                        <td>
                            <button onclick="deleteCartItemById(${value.cartId})">Delete</button>
                        </td>
                    </tr>`;
        return drawTable;
    }

    let updateTable;

    function loadData() {
        updateTable = "";
        fetch('/cart/showcart')
            .then(response => response.json())
            .then(data => {
                data.forEach(item => {
                    updateTable += showCart(item);
                })
                document.getElementById("draw-table").innerHTML = updateTable;
                data.forEach(
                    item => {
                        let subTotalItem = subTotal(item.quantity, item.product.price);
                        document.getElementById(`subTotal-${item.cartId}`).innerHTML = formatNumber(subTotalItem)
                    }
                )
                doCheckedFromHolderInputCheckBoxArr();
            })
            .catch(error => console.error(error));
    }

    loadData();

    function deleteCartItemById(id) {
        fetch('/cart/delete?idDel=' + id, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
        })
            .then(response => {
                if (response.ok) {
                    loadData();
                    document.getElementById("total").innerHTML = formatNumber(total1);
                } else {
                    console.log('Có lỗi xảy ra khi cập nhật số lượng sản phẩm!');
                }
            })
            .catch(error => {
                console.error('Có lỗi xảy ra khi gửi request:', error);
            });
    }

    const selectAll = document.querySelector('#select-all');
    const items = document.getElementsByClassName('check-btn');

    let total1;

    function countIfCheckedCheckBox() {
        total1 = 0;
        holdCheckedInput = [];
        for (let i = 0; i < items.length; i++) {
            if (items[i].checked) {
                holdCheckedInput.push(items[i].getAttribute("id"));
                console.log(items[i].getAttribute("id"));
                let currentCheckedPrice = +document.getElementById(`subTotal-${items[i].getAttribute("id")}`).innerText.replace("₫", "").replace(/\./g, "").trim();
                console.log(currentCheckedPrice)
                total1 += currentCheckedPrice;
            }
        }
        console.log(holdCheckedInput)
        document.getElementById("total").innerHTML = formatNumber(total1);
    }

    function doCheckedFromHolderInputCheckBoxArr() {
        console.log("in render input check box")
        for (let i = 0; i < holdCheckedInput.length; i++) {
            document.getElementById(holdCheckedInput[i]).checked = true;
        }
        countIfCheckedCheckBox();
    }

    function checkInput() {
        countIfCheckedCheckBox();
        sendCheckedInput();
        for (let i = 0; i < items.length; i++) {
            if (items[i].checked === true) {
                selectAll.checked = true;
            } else {
                selectAll.checked = false;
                return;
            }
        }
    }

    function sendCheckedInput() {
        console.log(holdCheckedInput)
        fetch('/cart/updateCartStat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(
                holdCheckedInput
            )
        })
            .then(response => {
                if (response.ok) {
                    console.log("may qua khong loi")
                } else {
                    console.log('Có lỗi xảy ra khi cập nhật số lượng sản phẩm!');
                }
            })
            .catch(error => {
                console.error('Có lỗi xảy ra khi gửi request:', error);
            });
    }

    function checkAllInput() {
        for (let i = 0; i < items.length; i++) {
            if (selectAll.checked === true) {
                items[i].checked = true;
            } else {
                items[i].checked = false;
            }
        }
        countIfCheckedCheckBox();
        sendCheckedInput();
    }

    function updateQuantity(index) {
        let getIndex = "cartId" + "-" + index.toString();
        let fixQuantity = +document.getElementById(getIndex).value;
        fetch('/cart/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                id: getIndex,
                quantity: fixQuantity
            })
        })
            .then(response => {
                if (response.ok) {
                    loadData();
                    document.getElementById("total").innerHTML = formatNumber(total1);
                } else {
                    console.log('Có lỗi xảy ra khi cập nhật số lượng sản phẩm!');
                }
            })
            .catch(error => {
                console.error('Có lỗi xảy ra khi gửi request:', error);
            });
    }

    function subTotal(quantity, price) {
        return quantity * price;
    }

    function total(array) {
        return array.reduce((acc, cur) => acc + cur, 0);
    }

    function formatNumber(number) {
        return new Intl.NumberFormat("de-DE", {
            style: "currency",
            currency: "VND",
        }).format(number);
    }
</script>
</html>